---
title: Call Your API on a User's Behalf
description: Learn how to call an Auth0-protected API from your MCP server.
sidebarTitle: Call Your API on a User's Behalf
---

import MCPGetStartedPrerequisites from "/snippets/mcp/get-started/pre-reqs/prerequisites.mdx";
import MCPGetStartedConfigTenantSettings from "/snippets/mcp/get-started/config-tenant/config-tenant-settings.mdx";
import CreateProfile from "/snippets/mcp/get-started/create-custom-token-exchange-profile.mdx";
import CreateMCPAPI from "/snippets/mcp/get-started/create-mcp-api.mdx";
import { DownloadQuickstartButton } from "/snippets/download-quickstart/DownloadQuickstartButton.jsx";
import MCPGetStartedTestingInstructions from "/snippets/mcp/get-started/testing-instructions.mdx";

To call your APIs on behalf of your users, the MCP server needs to exchange the Auth0 access token it received from the MCP client (with the audience set to the MCP server itself) for a new Auth0 access token with the audience set to your API.

In Auth0, this is called Custom Token Exchange and uses [RFC 8693](https://www.rfc-editor.org/rfc/rfc8693.html). This flow involves the MCP server acting as both a resource server (for the client) and a client (for the upstream API).

By the end of this quickstart, you should have an MCP server that can:

* Exchange an Auth0 access token for another Auth0 access token with a different audience using Custom Token Exchange
* Verify the access token using the `@auth0/auth0-api-js` library (which uses `jose` under the hood) against your tenant JWKS, enforcing issuer, audience, and RS256

<MCPGetStartedPrerequisites />

<MCPGetStartedConfigTenantSettings />

## Set up the Auth0 Applications and APIs

When an MCP server needs to call underlying APIs, it needs to perform a Custom Token Exchange to obtain an access token with the audience set to the API rather than the MCP server itself. Because of this architecture, the MCP server acts in a dual role.

1. To the MCP client (e.g., an IDE, an AI assistant), the MCP server acts as a **Resource Server** (an API).
2. To the underlying API (e.g., your own API), the MCP server acts as a **Client**.

Because of this, you will set up the MCP server twice on your Auth0 tenant, both as an API and as a Client.

### Create an API to represent your MCP server

<CreateMCPAPI />

### Create an Application for your MCP server

In the custom token exchange scenario, the MCP server acts as a client in order to obtain an Auth0 access token with custom token exchange:

```shell wrap lines
auth0 api post clients --data '{
  "name": "MCP Server Client",
  "app_type": "non_interactive",
  "is_first_party": true,
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "client_secret_post",
  "oidc_conformant": true,
  "jwt_configuration": { "alg": "RS256" }
}' | jq -r '"{\"client_id\":\"" + .client_id + "\",\"client_secret\": \"" +  .client_secret + "\"}"' > auth0-app-details.json
```

The output of the command will be a JSON object with the `client_id` and `client_secret` of the newly created client, which will be used in the next steps to configure the MCP server environment.

Next, we need to indicate to Auth0 that the client can use Custom Token Exchange.

```shell
CLIENT_ID=$(jq -r '.client_id' auth0-app-details.json) \
&& auth0 api patch clients/${CLIENT_ID} --data '{
  "token_exchange": {
    "allow_any_profile_of_type": ["custom_authentication"]
  }
}'
```

And finally, because you need an API to call to, let's create one.

### Create a first-party API to call from the MCP server

Since your objective is to have the MCP server make a tool call that calls a protected first-party API you need to configure an API in Auth0, this will be your upstream API:

```shell
auth0 api post resource-servers --data '{
  "identifier": "http://localhost:8787/",
  "name": "Protected First Party API",
  "signing_alg": "RS256",
  "enforce_policies": true,
  "scopes": [
    {"value": "read:private", "description": "Private scope"}
  ]
}' | jq -r '"Audience: " + .identifier'
```

Save the `Audience` from the command output; you'll need it in a later step.


<Tabs>
  <Tab title="Use sample app (recommended)">
    Start by downloading the sample app for this quickstart. The sample includes a FastMCP MCP server with an Auth0 integration and a protected API built with
    [Fastify](https://fastify.dev/).

    <DownloadQuickstartButton
      category="auth-for-mcp"
      framework="fastmcp-mcp-customtokenexchange-js"
    />

    Once downloaded, extract the files and open the project in your preferred IDE.
</Tab>
  <Tab title="Clone GitHub repository">
    Clone the repository and navigate to the sample app folder which includes a FastMCP MCP server with an Auth0 integration and a protected API built with
    [Fastify](https://fastify.dev/).

    ```shell wrap lines
    git clone https://github.com/auth0-samples/auth0-ai-samples.git
    cd auth0-ai-samples/auth-for-mcp/fastmcp-mcp-customtokenexchange-js
    ```

    Once cloned, open the project in your preferred IDE.
  </Tab>
</Tabs>

The sample app demonstrates custom token exchange with a `greet` tool that calls your protected API on behalf of the authenticated user.

## Install packages

Ensure you have npm installed or follow the instructions to [install npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) in its documentation. In the `fastmcp-mcp-customtokenexchange-js` directory, install the required packages:

```shell
npm install
```

## Create your environment file

In the `fastmcp-mcp-customtokenexchange-js` directory, run the following command to create a new `.env` file populated with all the required environment variables:

```shell wrap lines expandable
CLIENT_ID=$(jq -r '.client_id' auth0-app-details.json) \
&& CLIENT_SECRET=$(jq -r '.client_secret' auth0-app-details.json) \
&& DOMAIN=$(auth0 tenants list --json | jq -r '.[] | select(.active == true) | .name') \
&& touch .env \
&& echo "AUTH0_DOMAIN=${DOMAIN}" > .env \
&& echo "AUTH0_AUDIENCE=http://localhost:3001/" >> .env \
&& echo "PORT=3001" >> .env \
&& echo "MCP_SERVER_URL=http://localhost:3001/" >> .env \
&& echo "MCP_AUTH0_CLIENT_ID=${CLIENT_ID}" >> .env \
&& echo "MCP_AUTH0_CLIENT_SECRET=${CLIENT_SECRET}" >> .env \
&& echo "MCP_AUTH0_SUBJECT_TOKEN_TYPE=urn:fastmcp:mcp" >> .env \
&& echo "MCP_AUTH0_EXCHANGE_SCOPE=read:tasks" >> .env \
&& echo "API_AUTH0_AUDIENCE=http://localhost:8787/" >> .env \
&& echo "API_BASE_URL=http://localhost:8787/" >> .env \
&& rm auth0-app-details.json \
&& echo ".env file created with your Auth0 details:" \
&& cat .env
```

To get your Auth0 applicationâ€™s `AUTH0_DOMAIN`, run the following command:

```shell
auth0 tenants list
```

Copy the domain under `TENANT` from the output and update the corresponding variable in the `.env` file.

For `MCP_AUTH0_CLIENT_ID` and `MCP_AUTH0_CLIENT_SECRET` you will use the values obtained from the [Create an Application for your MCP server](./call-your-apis-on-users-behalf#create-an-application-for-your-mcp-server) step.

## Use Custom Token Exchange Action

This Action is the server-side logic Auth0 executes to perform the token exchange. It is necessary because the MCP server receives an access token from the client (with the MCP server as its audience) and must exchange it for a new token (with the upstream API as the audience). This Action validates the original token and mints the new one.

The Custom Token Exchange Action is available as part of Custom Token Exchange Early Access. Navigate to [the On-behalf-of token exchange for first-party apps template available here](https://manage.auth0.com/#/actions/library/templates/templates/daeda4e8-8da2-4abb-afb5-ac09df0ebb2a) and click on **Use This Template**.

<Frame>
  <img
    src="/img/mcp/cte_action_template_page.png"
    alt="Action On-behalf-of token exchange for first-party apps template page"
  />
</Frame>

This will open a modal for you to name the action:

<Frame>
  <img
    class="img-sizing"
    src="/img/mcp/cte_action_creation_modal.png"
    alt="Action creation modal"
  />
</Frame>

Once the action is created, you can **Deploy** it. When you deploy the Action, Auth0 assigns it an Action ID. You still need to add your custom logic to the Action, but first, get the Action ID to create the Custom Token Exchange Profile.

## Set up the token exchange profile

<CreateProfile />

## Run the MCP server and the API

Run this command to start your server:

```shell
npm run start
```

And in a separate window run this command to start the API:

```shell
npm run start:api
```

## Exchange your access token

To call your APIs on behalf of your users, the MCP server needs to exchange the Auth0 access token it received from the MCP client (with the audience set to the MCP server itself) for a new Auth0 access token with the audience set to your API. In Auth0, this is called Custom Token Exchange and uses [RFC 8693](https://www.rfc-editor.org/rfc/rfc8693.html).

### The Orchestrator: `bearerForUpstream`

The process begins with the `bearerForUpstream` function. Its main job is to take the initial token (the `subjectToken`), manage the exchange process, and handle any potential errors gracefully.

This function serves as a safe wrapper around our exchange logic.

```shell wrap lines highlight={5}
async function bearerForUpstream(subjectToken: string) {
  if (!subjectToken) return { token: null, scopes: null };

  try {
    const result = await exchangeCustomToken(subjectToken);
    return {
      token: result.accessToken,
      scopes: result.scope,
    }
  } catch (err) {
    console.error('Error during token exchange:', err);
    throw err;
  }
}
```

As you can see, it calls `exchangeCustomToken` and, on a successful exchange, returns the new `accessToken` and its associated scope. If the exchange fails, it logs the error and re-throws it to be handled upstream.

### The core logic: `exchangeCustomToken`

This function, located in `src/auth0.ts`, contains the actual token exchange logic. It uses the `ApiClient` from the `auth0-api-js` SDK to simplify the interaction with Auth0's `/oauth/token` endpoint.

First, we initialize the `ApiClient` with the credentials of the application performing the exchange:

```javascript wrap lines
 const exchangeClient = new ApiClient({
  domain: AUTH0_DOMAIN,
  audience: API_AUTH0_AUDIENCE,
  clientId: MCP_AUTH0_CLIENT_ID,
  clientSecret: MCP_AUTH0_CLIENT_SECRET,
});
```
With the client configured, the `exchangeCustomToken` function calls the `getTokenByExchangeProfile` method. This method implements the [Custom Token Exchange](https://auth0.com/docs/authenticate/custom-token-exchange) flow.

```javascript wrap lines
export async function exchangeCustomToken(subjectToken: string) {
    return await exchangeClient.getTokenByExchangeProfile(subjectToken, {
      subjectTokenType: MCP_AUTH0_SUBJECT_TOKEN_TYPE,
      audience: API_AUTH0_AUDIENCE,
      ...(MCP_AUTH0_EXCHANGE_SCOPE && { scope: MCP_AUTH0_EXCHANGE_SCOPE }),
    });
}
```

<MCPGetStartedTestingInstructions />

## Next steps

* To set up MCP server authorization, complete the [Authorization for Your MCP Server](./authorization-for-your-mcp-server) quickstart.
