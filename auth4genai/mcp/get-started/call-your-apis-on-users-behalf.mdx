---
title: Call Your API on User's Behalf
description: Learn how to call an Auth0-protected API from your MCP Server.
sidebarTitle: Call Your API on User's Behalf
---

import MCPGetStartedPrerequisites from "/snippets/mcp/get-started/pre-reqs/prerequisites.mdx";
import MCPGetStartedConfigTenantSettings from "/snippets/mcp/get-started/config-tenant/config-tenant-settings.mdx";
import CreateProfile from "/snippets/mcp/get-started/create-custom-token-exchange-profile.mdx";
import CreateMCPAPI from "/snippets/mcp/get-started/create-mcp-api.mdx";
import { DownloadQuickstartButton } from "/snippets/download-quickstart/DownloadQuickstartButton.jsx";
import MCPGetStartedTestingInstructions from "/snippets/mcp/get-started/testing-instructions.mdx";

To call your APIs on behalf of your users, the MCP Server needs to exchange the Auth0 access token it received from the MCP Client (with the audience set to the MCP Server itself) for a new Auth0 access token with the audience set to your API. In Auth0, this is called Custom Token Exchange and uses [RFC 8693](https://www.rfc-editor.org/rfc/rfc8693.html).

By the end of this quickstart, you should have an MCP server that can:

* Exchange an Auth0 access token for another Auth0 access token with a different audience using Custom Token Exchange
* Verify the access token using the `@auth0/auth0-api-js` library (which uses `jose` under the hood) against your tenant JWKS, enforcing issuer, audience, and RS256

<MCPGetStartedPrerequisites />

<MCPGetStartedConfigTenantSettings />

## Create an Application for your MCP Server

In the custom token exchange scenario, the MCP server acts as a client in order to obtain an Auth0 access token with custom token exchange:

```shell wrap lines
auth0 api post clients --data '{
  "name": "MCP Server Client",
  "app_type": "non_interactive",
  "is_first_party": true,
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "client_secret_post",
  "oidc_conformant": true,
  "jwt_configuration": { "alg": "RS256" }
}' | jq -r '"\nClient ID:     " + .client_id + "\nClient Secret: " +  .client_secret'
```

Save the `Client ID` and the `Client Secret` from the output.

Now use the `Client ID` from the last command and allow your client to use custom token exchange:

```shell
auth0 api patch clients/<client_id> --data '{
  "token_exchange": {
    "allow_any_profile_of_type": ["custom_authentication"]
  }
}'
```

## Create a first-party API to call from the MCP Server

Since your objective is to have the MCP server make a tool call that calls a protected first-party API you need to configure an API in Auth0, this will be your upstream API:

```shell
auth0 api post resource-servers --data '{
  "identifier": "http://localhost:8787/",
  "name": "Protected First Party API",
  "signing_alg": "RS256",
  "enforce_policies": true,
  "scopes": [
    {"value": "read:private", "description": "Private scope"}
  ]
}' | jq -r '"\nAudience:     " + .identifier'
```

Save the `Audience` from the command output, you'll need it on a later step.

<CreateMCPAPI />

## Download sample app

Start by downloading the sample app for this quickstart. The sample includes a FastMCP MCP Server with Auth0 integration and a protected API built with
[Fastify](https://fastify.dev/).

<DownloadQuickstartButton
  category="auth-for-mcp"
  framework="fastmcp-mcp-customtokenexchange-js"
/>

Once downloaded, extract the files and open the project in your preferred IDE.

<Expandable title="Or if you prefer to clone the repository...">

Clone the repository and navigate to the correct folder:

```shell wrap lines
git clone https://github.com/auth0-samples/auth0-ai-samples.git
cd auth0-ai-samples/auth-for-mcp/fastmcp-mcp-customtokenexchange-js
```
</Expandable>

The sample demonstrates custom token exchange with a `greet` tool that calls your protected API on behalf of authenticated users.

## Install packages

Ensure you have npm installed or follow the instructions to [install npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) in its documentation. In the `fastmcp-mcp-customtokenexchange-js` directory, install the required packages:

```shell
npm install
```

## Create your environment file

In the `fastmcp-mcp-customtokenexchange-js` directory, rename the `.env.example` to `.env` file and update the following content:

```shell wrap lines expandable
# Auth0 tenant domain
AUTH0_DOMAIN=<your-tenant.auth0.com>
# Auth0 API Identifier
AUTH0_AUDIENCE=http://localhost:3001/

# Server port
PORT=3001

# MCP server URL
MCP_SERVER_URL=http://localhost:3001/

# MCP Auth0 client credentials and configuration
MCP_AUTH0_CLIENT_ID=your-client-id
MCP_AUTH0_CLIENT_SECRET=your-client-secret

# Subject token type for CTE
MCP_AUTH0_SUBJECT_TOKEN_TYPE=urn:fastmcp:mcp

# Scopes to request
MCP_AUTH0_EXCHANGE_SCOPE=read:tasks

# Upstream API configuration
API_AUTH0_AUDIENCE=http://localhost:8787/
API_BASE_URL=http://localhost:8787/
```

To get your Auth0 applicationâ€™s `AUTH0_DOMAIN`, run the following command:

```shell
auth0 tenants list
```

Copy the domain under `TENANT` from the output and update the corresponding variable on the `.env`.

For `MCP_AUTH0_CLIENT_ID` and `MCP_AUTH0_CLIENT_SECRET` you will use the values obtained on the [Create an Application for your MCP Server](./call-your-apis-on-users-behalf#create-an-application-for-your-mcp-server) step.

## Use Custom Token Exchange Action

The Custom Token Exchange Action, available as a part of Custom Token Exchange Early Access. Navigate to [the On-behalf-of token exchange for first-party apps template available here](https://manage.auth0.com/#/actions/library/templates/templates/daeda4e8-8da2-4abb-afb5-ac09df0ebb2a) and click on **Use This Template**.

<Frame>
  <img
    src="/img/mcp/cte_action_template_page.png"
    alt="Action On-behalf-of token exchange for first-party apps template page"
  />
</Frame>

This will open a modal for you to name the action:

<Frame>
  <img
    class="img-sizing"
    src="/img/mcp/cte_action_creation_modal.png"
    alt="Action creation modal"
  />
</Frame>

Once the action is created you can **Deploy** it. When you deploy the Action, Auth0 assigns it an Action ID. You still need to add your custom logic to the Action, but first, get the Action ID to create the Custom Token Exchange Profile.

## Setup the token exchange profile

<CreateProfile />

## Create an Application to represent your MCP client

The MCP client will provide the interface to connect to your MCP server. For this quickstart we will use [MCP Inspector](https://modelcontextprotocol.io/docs/tools/inspector) as our client.

Run this command to create the client:

```shell wrap lines
auth0 api post clients --data '{
  "name": "MCP Inspector",
  "app_type": "regular_web",
  "is_first_party": false,
  "callbacks": ["http://localhost:6274/oauth/callback"],
  "grant_types": ["authorization_code"],
  "token_endpoint_auth_method": "client_secret_post",
  "oidc_conformant": true,
  "jwt_configuration": { "alg": "RS256" },
  "logo_uri": "https://avatars.githubusercontent.com/u/182288589"
}' | jq -r '"\nClient ID:     " + .client_id + "\nClient Secret: " +  .client_secret'
```

Save the `Client ID` and `Client Secret` from the command output.

## Run the MCP Server and the API

Run this command to start your server:

```shell
npm run start
```

And in a separate window run this command to start the API:

```shell
npm run start:api
```

## Exchange your access token

To call your APIs on behalf of your users, the MCP Server needs to exchange the Auth0 access token it received from the MCP Client (with the audience set to the MCP Server itself) for a new Auth0 access token with the audience set to your API. In Auth0, this is called Custom Token Exchange and uses [RFC 8693](https://www.rfc-editor.org/rfc/rfc8693.html).

### The Orchestrator: `bearerForUpstream`

The process begins with the `bearerForUpstream` function. Its main job is to take the initial token (the `subjectToken`), manage the exchange process, and handle any potential errors gracefully.

This function serves as a safe wrapper around our exchange logic.

```shell wrap lines highlight={5}
async function bearerForUpstream(subjectToken: string) {
  if (!subjectToken) return { token: null, scopes: null };

  try {
    const result = await exchangeCustomToken(subjectToken);
    return {
      token: result.accessToken,
      scopes: result.scope,
    }
  } catch (err) {
    console.error('Error during token exchange:', err);
    throw err;
  }
}
```

As you can see, it calls `exchangeCustomToken` and, on a successful exchange, returns the new `accessToken` and its associated scope. If the exchange fails, it logs the error and re-throws it to be handled upstream.

### The core logic: `exchangeCustomToken`

This function, located in `src/auth0.ts`, contains the actual token exchange logic. It uses the `ApiClient` from the `auth0-api-js` SDK to simplify the interaction with Auth0's `/oauth/token` endpoint.

First, we initialize the `ApiClient` with the credentials of the application performing the exchange:

```javascript wrap lines
 const exchangeClient = new ApiClient({
  domain: AUTH0_DOMAIN,
  audience: API_AUTH0_AUDIENCE,
  clientId: MCP_AUTH0_CLIENT_ID,
  clientSecret: MCP_AUTH0_CLIENT_SECRET,
});
```
With the client configured, the `exchangeCustomToken` function calls the `getTokenByExchangeProfile` method. This method implements the [Custom Token Exchange](https://auth0.com/docs/authenticate/custom-token-exchange) flow.

```javascript wrap lines
export async function exchangeCustomToken(subjectToken: string) {
    return await exchangeClient.getTokenByExchangeProfile(subjectToken, {
      subjectTokenType: MCP_AUTH0_SUBJECT_TOKEN_TYPE,
      audience: API_AUTH0_AUDIENCE,
      ...(MCP_AUTH0_EXCHANGE_SCOPE && { scope: MCP_AUTH0_EXCHANGE_SCOPE }),
    });
}
```

<MCPGetStartedTestingInstructions />

## Next steps

* To set up user authentication, complete the [User Authentication](./user-authentication) quickstart.







