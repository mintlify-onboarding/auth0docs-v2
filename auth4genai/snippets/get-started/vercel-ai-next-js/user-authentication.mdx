import { Prerequisites } from "/snippets/get-started/prerequisites/user-authentication.jsx";
import { AccountAndAppSteps } from "/snippets/get-started/prerequisites/account-app-steps.jsx";
import { DownloadQuickstartButton } from "/snippets/download-quickstart/DownloadQuickstartButton.jsx";

<Prerequisites />

<Tabs>
  <Tab
    title="Use sample app (recommended)"
  >

### Download sample app
Start by downloading and extracting the sample app. Then open in your preferred IDE.
<DownloadQuickstartButton
  category="authenticate-users"
  framework="vercel-ai-next-js"
/>

### Install packages
Ensure you have `npm` installed or follow the instructions to [install npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm) in its documentation.
In the root directory of your project, install the required packages:

```bash wrap lines
npm install
```

### Create your environment file
In the root directory of your project, create a new `.env.local` file and add the following content:

```bash .env.local wrap lines
APP_BASE_URL='http://localhost:3000'
AUTH0_SECRET='random 32 byte value'
AUTH0_DOMAIN='<your-auth0-domain>'
AUTH0_CLIENT_ID='<your-auth0-application-client-id>'
AUTH0_CLIENT_SECRET='<your-auth0-application-client-secret>'
```
To get your Auth0 application's `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID`, and `AUTH0_CLIENT_SECRET`, navigate to <strong>Applications > Applications </strong> in the Auth0 Dashboard and select your client application. You'll find these values in the **Basic Information** section at the top.
Copy each value to the matching setting.

Next, run this command to generate a random 32 byte value and copy it to the `AUTH0_SECRET` field:
```bash generate random 32 byte value
openssl rand -hex 32
```

### Run your application

Run this command to start your server:

```bash wrap lines
npm run dev
```

Visit the URL `http://localhost:3000` in your browser.

You will see:

<Frame>
  ![Auth0 login screen](/img/user_authentication_quickstart_login_screen.png)
</Frame>

Sign up for your application to create a new user account. You will then see a welcome message with your username. You can sign in with that account on future visits.


  </Tab>
  <Tab
    title="Integrate into your app"
  >
### Install Auth0 Next.js SDK

In the root directory of your project, install the [Auth0 Next.js SDK](http://next.js/):

```bash wrap lines
npm i @auth0/nextjs-auth0@4
```

### Add log in to your application

Secure your application using the Auth0 Next.js SDK.

#### Create your environment file

In the root directory of your project, create or add the following content to your `.env.local` file:

```bash .env.local wrap lines
APP_BASE_URL='http://localhost:3000'
AUTH0_SECRET='random 32 byte value'
AUTH0_DOMAIN='<your-auth0-domain>'
AUTH0_CLIENT_ID='<your-auth0-application-client-id>'
AUTH0_CLIENT_SECRET='<your-auth0-application-client-secret>'
```
Access your `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID`, and `AUTH0_CLIENT_SECRET` by viewing the Auth0 Application that you created in the Auth0 Dashboard and navigating to the Basic Information section at the top of the Settings tab.
Copy each value to the matching setting.

Next, run this command to generate a random 32 byte value and copy it to the `AUTH0_SECRET` field.
```bash generate random 32 byte value
openssl rand -hex 32
```

#### Create the Auth0 client

Create a new file in the `src/lib` directory and name it `auth0.ts`. Add the following code to create a new Auth0 client:

```tsx src/lib/auth0.ts wrap lines
import { Auth0Client } from "@auth0/nextjs-auth0/server";

// Create an Auth0 Client.
export const auth0 = new Auth0Client();
```

The Auth0 client provides methods for handling authentication, sessions, and user data.

#### Add the authentication middleware

The middleware intercepts incoming requests and applies Auth0's authentication logic. Create a new file in the `src` directory and name it `middleware.ts` or update your existing middleware file. Add the following code to the file:

```tsx src/middleware.ts wrap lines
import { NextRequest, NextResponse } from "next/server";
import { auth0 } from "./lib/auth0";

export async function middleware(request: NextRequest) {
  const authRes = await auth0.middleware(request);

  // Authentication routes â€” let the Auth0 middleware handle it.
  if (request.nextUrl.pathname.startsWith("/auth")) {
    return authRes;
  }

  const { origin } = new URL(request.url);
  const session = await auth0.getSession(request);

  // User does not have a session â€” redirect to login.
  if (!session) {
    return NextResponse.redirect(`${origin}/auth/login`);
  }
  return authRes;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image, images (image optimization files)
     * - favicon.ico, sitemap.xml, robots.txt (metadata files)
     * - $ (root)
     */
    "/((?!_next/static|_next/image|images|favicon.[ico|png]|sitemap.xml|robots.txt|$).*)",
  ],
};
```

#### Add Log in and Sign up buttons

Use the following code example to check if the user is signed in or not:
It will display the **Sign up** or **Log in** buttons without a user session. If a user session exists, the app displays a welcome message with the user's name.

```tsx src/app/page.tsx wrap lines highlight={5,7-27, 36}
//...
import { auth0 } from "@/lib/auth0";

export default async function Home() {
  const session = await auth0.getSession();

  if (!session) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] my-auto gap-4">
        <h2 className="text-xl">You are not logged in</h2>
        <div className="flex gap-4">
          <Button asChild variant="default" size="default">
            <a href="/auth/login" className="flex items-center gap-2">
              <LogIn />
              <span>Login</span>
            </a>
          </Button>
          <Button asChild variant="default" size="default">
            <a href="/auth/login?screen_hint=signup">
              <UserPlus />
              <span>Sign up</span>
            </a>
          </Button>
        </div>
      </div>
    );
  }

  //... existing code

  // applicable only if you are using the starter template
  return (
    <ChatWindow
      endpoint="api/chat"
      emoji="ðŸ¤–"
      placeholder={`Hello ${session?.user?.name}, I'm your personal assistant. How can I help you today?`}
      emptyStateComponent={InfoCard}
    />
  );
}
```

### Run your application

Start your app, typically with this command:

```bash wrap lines
npm run dev
```

Visit your app in the browser, typically at `http://localhost:3000`.

You will see:

<Frame>
  ![Auth0 login screen](/img/user_authentication_quickstart_login_screen.png)
</Frame>

Sign up to your application to create a new user account. You will then see a welcome message with your user name. You can sign in with that account on future visits.

### View a complete example
Want to see how it all comes together? Explore or clone the fully implemented sample application on [GitHub](https://github.com/auth0-samples/auth0-ai-samples/tree/main/authenticate-users/vercel-ai-next-js).

  </Tab>
</Tabs>
