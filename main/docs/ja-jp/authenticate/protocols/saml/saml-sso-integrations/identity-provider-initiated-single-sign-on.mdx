---
title: "SAML IDプロバイダー起点のシングルサインオンを構成する"
permalink: "identity-provider-initiated-single-sign-on"
'description': "SAML IDプロバイダー起点のシングルサインオン（SSO）を設定する方法について説明します。"
'og:title': "SAML IDプロバイダー起点のシングルサインオンを構成する"
'og:description': "SAML IDプロバイダー起点のシングルサインオン（SSO）を設定する方法について説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "SAML IDプロバイダー起点のシングルサインオンを構成する"
'twitter:description': "SAML IDプロバイダー起点のシングルサインオン（SSO）を設定する方法について説明します。"
---
import {AuthCodeBlock} from "/snippets/AuthCodeBlock.jsx";


<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-1" href="/docs/ja-jp/glossary?term=security-assertion-markup-language" tip="Security Assertion Markup Language（SAML）: パスワードなしに二者間で認証情報を交換できる標準化プロトコル。" cta="用語集の表示">SAML</Tooltip>フェデレーションをセットアップする手順の多くは、サービスプロバイダーによって開始されるシングルサインオン（<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/docs/ja-jp/glossary?term=single-sign-on" tip="シングルサインオン（SSO）: ユーザーが1つのアプリケーションにログインした後、そのユーザーを他のアプリケーションに自動的にログインさせるサービス。" cta="用語集の表示">SSO</Tooltip>）から始まります。サービスプロバイダーは、認証の目的でユーザーをIDプロバイダー（<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-2" href="/docs/ja-jp/glossary?term=idp" tip="IDプロバイダー（IdP）: デジタルIDを保存および管理するサービス。" cta="用語集の表示">IdP</Tooltip>）にリダイレクトします。このプロセスは、消費者向けのシナリオでよく使用されます。

ただし、エンタープライズのシナリオでは、サービスプロバイダーではなくIdPによってSSOが開始されることが一般的です。たとえば、エンタープライズは、ユーザーがポータルにサインオンした後に正しいアプリケーションに移動できるようにポータルをセットアップする場合があります。

## リスクと検討事項

IdP起点フローにはセキュリティリスクがあるため、お勧めできません。可能な限り、SP起点フローの使用をお勧めします。

IdP起点SSOを有効にする前に、必ずリスクについて理解しておいてください。このシナリオでは、Auth0がIdPから一方的な応答を受信し、アプリケーションがAuth0から一方的な応答を受信します。どちらのエンティティも、ユーザーがフローを開始したことを確認できません。このため、このフローを有効にすると、[ログインCSRF攻撃](https://support.detectify.com/support/solutions/articles/48001048951-login-csrf)にさらされる可能性が高まり、攻撃者は正当なユーザーをだまして、攻撃者のIDを使って無意識のうちにアプリケーションにログインさせることができます。

### OpenID ConnectのIdP起点フロー

<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/docs/ja-jp/glossary?term=openid" tip="OpenID: アプリケーションがログイン情報を収集および保存することなくにユーザーのIDを検証できるようにする認証用のオープン標準。" cta="用語集の表示">OpenID</Tooltip> Connect（OIDC）は、IdP起点フローの概念をサポートしていません。そのため、Auth0は、（SAML接続からの）SAML IdP起点フローをアプリケーションのOIDC応答に変換できる機能を提供しますが、OIDC/OAuth2プロトコルを適切に実装しているアプリケーションは要求されていない応答を拒否します。

OIDCアプリケーションを使用する場合、最良のオプションは、アプリケーションにログインエンドポイントを作成させることです。このエンドポイントの唯一の目的は、IdP（Auth0テナント）へのリダイレクトを開始することです。

複数のIdPを使用する場合は、ログインエンドポイントがIDプロバイダーに固有であるか、ワークフローを開始するIdPを識別するパラメーターを受け入れられることを確認してください。

別のアプローチとして、ユーザーがアプリケーションでログインフローを開始することもできます。

### ポストバックURL

IdP起点SSOを使用する場合は、必ずポストバックURLに接続パラメーターを含めてください。

export const codeExample1 = `https://{yourDomain}/login/callback?connection={yourConnectionName}`;

<AuthCodeBlock children={codeExample1} language="http" />

[Organizations](https://auth0.com/docs/manage-users/organizations)機能を使用している場合は、必要に応じて、目的の組織の組織IDを含む、次の組織パラメーターを含めることもできます。

export const codeExample2 = `https://{yourDomain}/login/callback?connection={yourConnectionName}&organization={yourCustomersOrganizationId}`;

<AuthCodeBlock children={codeExample2} language="http" />

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

ユーザーがこの方法でログインするためには、Organizationに対して接続が有効化されていなければなりません。また、有効な接続で[auto-membership](https://auth0.com/docs/manage-users/organizations/configure-organizations/grant-just-in-time-membership)が構成されているか、ユーザーがそのOrganizationのメンバーでなければなりません。

</Callout>

### Lock/Auth0.js

アプリケーションが、Lock またはAuth0.jsを使用して認証結果を処理するシングルページアプリケーションの場合は、IdP起点フローを許可することを明示的に示す必要があり、その結果、アプリケーションがログインCSRF攻撃にさらされる可能性があります。

Auth0.jsを使用している場合は、ライブラリーの`webAuth.parseHash`を更新し、フラグ `__enableIdPInitiatedLogin`を`true`に設定する必要があります。

```javascript lines
var data = webAuth.parseHash(
      {
        ...
        __enableIdPInitiatedLogin: true
        ...
      }
```

Lockを使用する場合は、コンストラクターに送信されるオプションのパラメーターを使用してフラグを含めることができます。

`const lock = new Auth0Lock(clientID, domain, options)`

フラグ自体は次のとおりです：

`var options = {
_enableIdPInitiatedLogin: true
};`

`enableIdPInitiatedLogin`フラグの前に、Lockで使用する場合は1つのアンダースコア、auth0.jsライブラリーで使用する場合は2つのアンダースコアがそれぞれ付くことに注意してください。

## IDP起点SSOをセットアップする

1. [［Dashboard］>［Authentication（認証）］>［Enterprise（エンタープライズ）］](https://manage.auth0.com/#/connections/enterprise)の順に移動し、 **［SAMLP Identity Provider（SAMLP IDプロバイダー）］** を選択します。
2. **［Settings（設定）］** で、IdP起点SSOの構成を確認できます。

   <Frame>![プロトコル - IdP起点SSOの構成画面](/docs/images/ja-jp/cdy7uua7fh8z/1HORCAp4fZQg0BOoIopvoS/11f3b6071383ddc6967c40138d5d1794/2025-01-28_13-46-21.png)</Frame>

* **IdP-initiated SSO Behavior（IdP起点SSOの動作）** ：このオプションを使用すると、SAML接続に対してIdP起点のログインを有効にすることができます。 **［Accept Requests（要求を受け入れる）］** を選択し、すべての必須フィールドに値を入力します。
* **Default Application（デフォルトのアプリケーション）** ：IdP起点のログインが成功すると、これがユーザーをルーティングするアプリケーションとなります。この設定には、この接続で有効になっている利用可能なアプリケーションが表示されます。IdP起点でユーザーにログインさせるアプリケーションをドロップダウンから選択します。1つのSAML接続につき、IdP起点のログインに対して選択できるアプリケーションは1つだけです。
* **Response Protocol（応答プロトコル）** ：これは、選択した **デフォルトのアプリケーション** の接続に使用するプロトコルです。通常、アプリケーションはOpenID Connectプロトコルを使って構成されます（上記を参照）。ただし、アプリケーションにSAML2 Webアプリアドオンを構成しており、SAMLアサーションをルーティングしたい場合は、SAMLを選択する必要があります。有効なSAMLアサーションがポストバックURLに渡されると、Auth0は、選択された応答プロトコルを使用して、構成されたデフォルトのアプリケーションの最初に許可されたコールバックURLにログイン応答を送信します。OIDCを使用する場合、クエリ文字列フィールドを使用してこのプロトコルを変更し、`redirect_uri`を指定することができます。
* **Query String（クエリ文字列）** ：クエリ文字列のオプションは、OpenID Connectプロトコルが使用されるときの動作をカスタマイズするのに役立ちます。[クエリ文字列](https://en.wikipedia.org/wiki/Query_string)を使用して、パラメーターの設定に類似した複数のオプションを設定することができます。以下のように設定できます。

  <table class="table"><thead>
  <tr>
  <th>設定</th>
  <th>説明</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td>`redirect_uri`</td>
  <td>IdP起点のログインが完了したら、要求がアプリケーションの__Allowed Callback URLs（許可されているCallback URL）__にリスト表示されている最初のURLにリダイレクトされます。ただし、`redirect_uri`を設定している場合、IdPはこのURLにリダイレクトします。これにより、ワイルドカードを使用する設定されたサブドメインスキームがあり、ある特定のサブドメインのみにリダイレクトしたい場合などのケースに柔軟性を追加します。</td>
  </tr>
  <tr>
  <td>`scope`</td>
  <td>送信されたIDトークンのスコープを定義します。複数のスコープを設定できます。</td>
  </tr>
  <tr>
  <td>`response_type`</td>
  <td>SPAの暗黙付与フローのトークンを設定します。通常のWebアプリに対して認証コード付与フローのコードを設定できます。</td>
  </tr>
  </tbody>
  </table>

  <Warning>

  IdP起点フローでは、Callback URLのドメインが未検証の場合、Auth0サーバーはトークンにあるスコープを削除します。Auth0で未検証のドメインとして定義されているのは、`localhost`と[127.0.0.1](http://127.0.0.1/)のみです。どちらかをCallback URLとして使用すると、`/userinfo`エンドポイントからのトークンは空の応答を返します。要求したスコープのあるトークン応答を取得するには、検証済みのドメインを使用します。

  </Warning>

  クエリ文字列の例：
  `redirect_uri=https://jwt.io&scope=openid email&response_type=token`

## 100に制限されているアプリケーションドロップダウンリスト

IdP起点SSOでアプリケーションを **Default Application（デフォルトのアプリケーション）** として選択する場合で、かつそのアプリケーションがテナントのドロップダウンリストの最初の100個のアプリケーションに含まれていない場合は、<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/docs/ja-jp/glossary?term=management-api" tip="Management API: 顧客が管理タスクを実行できるようにするための製品。" cta="用語集の表示">Management API</Tooltip>を使用してそのアプリケーションを選択する必要があります。パッチを実行する必要があります。

```json lines
{
"options": {
"signInEndpoint": "yourIdpSignInUrl",
"idpinitiated": {
"client_id": "yourClientId",
"client_protocol": "saml",
"client_authorizequery": ""
},
"signingCert": "[copied-from-GET]"
}
}
```

## もっと詳しく

* [証明書やキーの文字列表現で作業する](/docs/ja-jp/authenticate/protocols/saml/saml-sso-integrations/work-with-certificates-and-keys-as-strings)