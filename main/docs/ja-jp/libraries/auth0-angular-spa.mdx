---
title: "シングルページアプリ用Auth0 Angular SDK"
permalink: "auth0-angular-spa"
'description': "シングルページアプリ用Auth0 Angular SDKについて説明します。"
'og:title': "シングルページアプリ用Auth0 Angular SDK"
'og:description': "シングルページアプリ用Auth0 Angular SDKについて説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "シングルページアプリ用Auth0 Angular SDK"
'twitter:description': "シングルページアプリ用Auth0 Angular SDKについて説明します。"
---

Auth0 Angular SDKは、Auth0を使用してAngularアプリケーションで認証と認可を実装するためのJavaScriptライブラリです。サービス、認証ガードとHTTPインターセプターを提供して、Angularアプリ内で一般的な認証タスクを処理できるようにします。

Auth0 Angular SDKは、付与とプロトコルの詳細、トークンの失効と更新、そして、トークンの保管とキャッシュをも処理します。内部では、[ユニバーサルログイン](/docs/ja-jp/authenticate/login/auth0-universal-login)と[PKCEを用いた認可コード付与フロー](/docs/ja-jp/get-started/authentication-and-authorization-flow/authorization-code-flow-with-pkce)を実装しています。

ライブラリは[GitHubで提供しており](https://github.com/auth0/auth0-angular)、[APIに関するさらなる詳細を読むことができます](https://auth0.github.io/auth0-angular/)。

## インストール

<Callout icon="file-lines" color="#0EA5E9" iconType="regular">

Angular SDKは、Angular SPAのバージョン14以降と互換性があります。

</Callout>

[Angular CLI](https://cli.angular.io/)を使用して、プロジェクトにSDKをインストールします：

`ng add @auth0/auth0-angular`

## 使用を開始する

SDKの統合を始めるには、プロジェクトに`AuthModule`をインポートし、Auth0クライアントアプリに構成します。

```javascript lines
import { BrowserModule } from '@angular/platform-browser';
import { NgModule } from '@angular/core';
import { AppComponent } from './app.component';

// Import the module from the SDK
import { AuthModule } from '@auth0/auth0-angular';

@NgModule({
  declarations: [AppComponent],
  imports: [
    BrowserModule,

    // Import the module into the application, with configuration
    AuthModule.forRoot({
      domain: '{yourDomain}',
      clientId: 'YOUR_AUTH0_CLIENT_ID',
      authorizationParams: {
        redirect_uri: window.location.origin,
      },
    }),
  ],

  bootstrap: [AppComponent],
})
export class AppModule {}
```

## ログイン

SDKはAngularの依存性注入システムに完全に対応しています。始めるには、`AuthService`タイプをコンポーネントにインポートして、コンストラクターに注入します。

そして、ユーザーログインを始めるために、サービスで`loginWithRedirect`または`loginWithPopup`メソッドを呼び出します。

```javascript lines
import { Component } from '@angular/core';

// Import the AuthService type from the SDK
import { AuthService } from '@auth0/auth0-angular';

@Component({
  selector: 'app-login',
  template: '<button (click)="login">Log in</button>',
  styles: [],
})
export class LoginComponent {
  // Inject the authentication service into your component through the constructor
  constructor(public auth: AuthService) {}

  login(): void {
    // Call this to redirect the user to the login page
    this.auth.loginWithRedirect();
  }
}
```

## ログアウト

`logout`を使用して、ユーザーをログアウトさせます。<Tooltip data-tooltip-id="react-containers-DefinitionTooltip-0" href="/docs/ja-jp/glossary?term=auth0-dashboard" tip="Auth0 Dashboard: サービスを構成するためのAuth0の主製品。" cta="用語集の表示">Auth0 Dashboard</Tooltip>の **［Allowed Logout URLs（許可されているログアウトURL）］** に`returnTo`が指定されていることを確認してください。

```javascript lines
import { Component } from '@angular/core';

// Import the AuthService type from the SDK
import { AuthService } from '@auth0/auth0-angular';

@Component({
  selector: 'app-logout',
  template: '<button (click)="logout">Log out</button>',
  styles: [],
})
export class LogoutComponent {
  // Inject the authentication service into your component through the constructor
  constructor(@Inject(DOCUMENT) private doc: Document, public auth: AuthService) {}

  login(): void {
    // Call this to redirect the user to the login page
    this.auth.logout({ 
      logoutParams: { 
        returnTo: this.doc.location.origin 
      }
    });
  }
}
```

## 認証状態

認証状態は`isAuthenticated$`オブザーバブルを通して公開されます。

```html lines
<div *ngIf="auth.isAuthenticated$ | async">
  <app-login></app-login>
</div>
```

## ユーザープロファイル

認証されたユーザーのユーザープロファイルは`user$`オブザーバブルを通して公開されます。

```html lines
<ul *ngIf="auth.user$ | async as user">
  <li>{{ user.name }}</li>
  <li>{{ user.email }}</li>
</ul>
```

このオブザーバブルは内部的に`isAuthenticated$`オブザーバブルと連鎖しているため、ユーザーがログインしたかを手動で確認する必要はありません。認証されたユーザーが使用可能になると、値を流し始めます。

## ルートの保護

経路コンポーネントは組み込みの`AuthGuard`を使用して保護します。認証されていない状態でこのルートにアクセスすると、ユーザーはログインページにリダイレクトされ、ログイン後にこのページに戻ってきます。

認証ガードは、`canActivate`フック（子経路を使用している場合には`canActivateChild`）を使って経路に追加する必要があります。

```javascript lines
import { NgModule } from '@angular/core';
import { Routes, RouterModule } from '@angular/router';
import { HomeComponent } from './unprotected/unprotected.component';
import { ProtectedComponent } from './protected/protected.component';

// Import the authentication guard
import { AuthGuard } from '@auth0/auth0-angular';

const routes: Routes = [
  {
    path: 'protected',
    component: ProtectedComponent,

    // Protect a route by registering the auth guard in the `canActivate` hook
    canActivate: [AuthGuard],
  },
  {
    path: '',
    component: HomeComponent,
    pathMatch: 'full',
  },
];

@NgModule({
  imports: [RouterModule.forRoot(routes)],
  exports: [RouterModule],
})
export class AppRoutingModule {}
```

また、認証ガードは`canLoad`フックにも対応し、ユーザーの認証時にモジュールの遅延読み込みを防げるようになっています。

## APIを呼び出す

SDKには組み込みの`HttpInterceptor`が含まれています。これは、Angularの`HttpClient`サービスを使って要求が行われた際に`Authorization`ヘッダーを注入し、自動的にアクセストークンをアタッチします。

SDKを構成して、どのAPIへの経路に自動でこのヘッダーを追加するのかを指定し、予期されない受信者にアクセストークンが漏洩することを防がなければなりません。

### HTTPインターセプターをインポートする

まず、Auth0 HTTPインターセプターをアプリに統合するために必要なタイプをインポートします。

```javascript lines
// Import the interceptor module and the Angular types you'll need
import { HttpClientModule, HTTP_INTERCEPTORS } from '@angular/common/http';
import { AuthHttpInterceptor } from '@auth0/auth0-angular';

// Register the interceptor with your app module in the `providers` array
@NgModule({
  declarations: [],
  imports: [
    BrowserModule,
    HttpClientModule,     // Register this so that you can make API calls using HttpClient
    AppRoutingModule,
    AuthModule.forRoot(...),
  ],
  providers: [
    { provide: HTTP_INTERCEPTORS, useClass: AuthHttpInterceptor, multi: true },
  ],
  bootstrap: [AppComponent],
})
```

**注意：** インターセプターは他のインターセプターと連鎖するように設計されているため、アプリケーションモジュールに（自動で登録するのではなく）手動で登録する必要があります。自動で正しい場所に挿入される保証はありません。

### HTTPインターセプターを構成する

必要に応じて、各種の構成方法があります。経路の指定では、文字列を使用したり、送信されるトークンに影響するオプションをオブジェクトに含めて使用したりできます。また、使用するHTTP動詞によっては一致させることもできます。経路のURIにはワイルドカードを使用して、経路のグループを指定することもできます。

**注意：** HTTP呼び出しが行われ、構成に指定されている経路と一致しない場合には、インターセプターが迂回され、`Authorization`ヘッダーは含まれません。

下の例は、どの経路に`Authorization`ヘッダーを含めるべきかをSDKに指示する一般的な方法です。

```javascript lines
// Modify your existing SDK configuration to include the httpInterceptor config
AuthModule.forRoot({
  domain: '{yourDomain}',
  clientId: 'YOUR_AUTH0_CLIENT_ID',
  authorizationParams: {
    redirect_uri: window.location.origin,
  },

  // The AuthHttpInterceptor configuration
  httpInterceptor: {
    allowedList: [
      // Attach access tokens to any calls to '/api' (exact match)
      '/api',

      // Attach access tokens to any calls that start with '/api/'
      '/api/*',

      // Match anything starting with /api/accounts, but also specify the audience and scope the attached
      // access token must have
      {
        uri: '/api/accounts/*',
        tokenOptions: {
          authorizationParams: {
            audience: 'http://my-api/',
            scope: 'read:accounts',
          }
        },
      },

      // Matching on HTTP method
      {
        uri: '/api/orders',
        httpMethod: 'post',
        tokenOptions: {
          authorizationParams: {
            audience: 'http://my-api/',
            scope: 'write:orders',
          }
        },
      },

      // Using an absolute URI
      {
        uri: 'https://your-domain.auth0.com/api/v2/users',
        tokenOptions: {
          authorizationParams: {
            audience: 'https://your-domain.com/api/v2/',
            scope: 'read:users',
          }
        },
      },
    ],
  },
});
```

**注意：** `tokenOptions`は、基礎となるSPA SDKで`getTokenSilently`メソッドに直接渡されます。受け付けられるプロパティの詳細については、[こちらのドキュメント](https://auth0.github.io/auth0-spa-js/interfaces/gettokensilentlyoptions.html)を参照してください。

### APIを呼び出す

Angularの`HttpClient`サービスを使用して、APIを呼び出します。構成と一致する経路については、アクセストークンが`Authorization`ヘッダーに自動的に含められます。

```javascript lines
export class MyComponent {
  constructor(private http: HttpClient) {}

  callApi(): void {
    this.http.get('/api').subscribe(result => console.log(result));
  }
}
```

呼び出しサイトでトークンや他の認可待ち行列を提供するために、追加で必要なものは一切ありません。インターセプターとモジュール構成によって処理されます。