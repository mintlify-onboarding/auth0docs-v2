---
title: "Amazon Web Servicesからユーザーを移行する"
permalink: "migrate-users-from-amazon-web-services"
'description': "Amazon Web Servicesからユーザーを移行する方法について説明します。"
'og:title': "Amazon Web Servicesからユーザーを移行する"
'og:description': "Amazon Web Servicesからユーザーを移行する方法について説明します。"
'og:image': "https://cdn2.auth0.com/docs/1.14567.0/img/share-image.png"
'twitter:title': "Amazon Web Servicesからユーザーを移行する"
'twitter:description': "Amazon Web Servicesからユーザーを移行する方法について説明します。"
---

2023年4月の時点で、ユーザーはAmazon Web Services（AWS）からAuth0に一括して移行できません。Auth0では、**自動移行** （別称「**レイジーローディング** 」）の使用をお勧めします。これを行うには、以下の手順に従います。

1. Auth0で[カスタムデータベースを構成](/docs/ja-jp/authenticate/database-connections/custom-db/create-db-connection)して、AWS Cognitoのユーザープールをポイントします。
2. Auth0へのユーザーインポートをTrueに設定します。
3. ユーザーの取得とユーザーのログインを行う2つのスクリプトを定義します。
4. Auth0の[get-user](/docs/ja-jp/authenticate/database-connections/custom-db/templates/get-user)スクリプトと[login](/docs/ja-jp/authenticate/database-connections/custom-db/templates/login)スクリプトでは、[amazon-cognito-identity-js npmパッケージのAPK](https://www.npmjs.com/package/amazon-cognito-identity-js)を使用して、ユーザーが自動的に移行されます。

以下はJavaScriptコードの例です。

##### get-user.js

```javascript lines
/*
    Requires Auth0 Global Variables to be set - https://auth0.com/docs/rules/configure-global-variables-for-rules
    If testing locally (or not wanting to use Auth0 Global Variables):
    const configuration = {
      "accessKeyId": "GQZDJNME56E3AJUBXMFOO",
      "secretAccessKey": "your-cognito-secret-access-key",
      "region": "eu-west-1",
      "UserPoolId": "eu-west-1_V69pvauTp"
    */

    function getUser(username, callback) {
const userParameters =  ["email", "email_verified", "custom:designation"];
const AWS = require('aws-sdk@2.593.0');
AWS.config.update({ "accessKeyId": configuration.accessKeyId, "secretAccessKey": configuration.secretAccessKey, "region": configuration.region });
const cognito = new AWS.CognitoIdentityServiceProvider();

cognito.adminGetUser({
    UserPoolId: configuration.UserPoolId,
    Username: username
}, (err, data) => {
    if (err) {
        console.log(err);
        if (err.code === "UserNotFoundException") return callback(null);
        else callback(err);
    }
    else {
        console.log(data);
        if (data.code === "UserNotFoundException") return callback(null);
        else {
            let profile = {
                "user_id": data.UserAttributes.find(item=>item.Name==="sub").Value,
                "username": data.Username,
            };
            userParameters.forEach(customParameterName => {
                profile[customParameterName] = data.UserAttributes.find(item=>item.Name===customParameterName).Value;
            });
            return callback(null, profile);
        }
    }

});

    }
```

##### login.js

```javascript lines
/*
    Read StackOverflow article about potential window issue: https://stackoverflow.com/questions/40219518/aws-cognito-unauthenticated-login-error-window-is-not-defined-js

    Requires Auth0 Global Variables to be set - https://auth0.com/docs/rules/configure-global-variables-for-rules

    If testing locally (or not wanting to use Auth0 Global Variables):
    const configuration = {
      "ClientId": "7tY2xt2NHwj3ZWfovz0wHrJ22IDr15XTyVlo08Xx",
      "UserPoolId": "eu-west-1_V69pvauTp"
    */

    function login(username, password, callback) {
global.fetch = require('node-fetch@2.6.0');
var AmazonCognitoIdentity = require('amazon-cognito-identity-js@3.0.14');
var poolData = {
    UserPoolId: configuration.UserPoolId,
    ClientId: configuration.ClientId

};
var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
    Username: username,
    Password: password
});
var userData = {
    Username: username,
    Pool: userPool
};
var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
cognitoUser.authenticateUser(authenticationDetails, {
    onSuccess: function (result) {
        //console.log(result);
        var idTokenPayload = result.getIdToken().payload;
        console.log(idTokenPayload);
        var profile = {
          user_id: idTokenPayload.sub,
          email: idTokenPayload.email,
          /* might want to set this to false if you're not validating email addresses */
          email_verified: true,
        };
        console.log({ result, idTokenPayload, profile });
        callback(null, profile);
    },
    onFailure: (function (err) {
        return callback(new WrongUsernameOrPasswordError(username))
    })
});
    }
```

