---
title: "Laravelアプリケーションに認可を追加する"
permalink: "interactive"
'description': "このガイドでは、新規（または既存）のLaravel 9または10アプリケーションにAuth0を統合する方法を説明します。"
'og:title': "Laravelアプリケーションに認可を追加する"
'og:description': "このガイドでは、新規（または既存）のLaravel 9または10アプリケーションにAuth0を統合する方法を説明します。"
'og:image': "/docs/media/platforms/php.png"
'twitter:title': "Laravelアプリケーションに認可を追加する"
'twitter:description': "このガイドでは、新規（または既存）のLaravel 9または10アプリケーションにAuth0を統合する方法を説明します。"
sidebarTitle: Laravel API
---

import { Recipe, Content, Section, SideMenu, SideMenuSectionItem, SignUpForm } from "/snippets/recipe.jsx";
import { LoggedInForm } from "/snippets/Login.jsx";
import Api from "/snippets/quickstart/backend/laravel/api.php.mdx";
import Api2 from "/snippets/quickstart/backend/laravel/api.php2.mdx";
import Api3 from "/snippets/quickstart/backend/laravel/api.php3.mdx";

export const sections = [
  { id: "laravelをインストールする", title: "Laravelをインストールする" },
  { id: "sdkをインストールする", title: "SDKをインストールする" },
  { id: "sdkを構成する", title: "SDKを構成する" },
  { id: "アクセス制御", title: "アクセス制御" },
  { id: "トークン情報", title: "トークン情報" },
  { id: "ユーザー情報を取得する", title: "ユーザー情報を取得する" },
  { id: "アプリケーションを実行する", title: "アプリケーションを実行する" },
  { id: "テストトークンを取得する", title: "テストトークンを取得する" }
]

<Recipe>
  <Content>
    [Auth0のLaravel SDK](https://github.com/auth0/laravel-auth0)を使用すると、Laravelアプリケーションにトークンベースの認可とルーティングに基づくアクセスコントロールを手軽に追加できます。このガイドでは、新規（または既存）の[Laravel 9または10](https://github.com/auth0/laravel-auth0#support-policy)アプリケーションにAuth0を統合する方法を説明します。

    ---

    **バックエンドアプリケーションが従来のWebアプリケーションと異なるのは、前者がユーザー認証を処理しない、またはユーザーインターフェイスを持っていない点にあります。バックエンドアプリケーションには、他のアプリケーションが対話できるAPIが用意されており、ルートへのアクセス制御を行うために、要求内の** **`Authorization`****ヘッダー** **からの**[**アクセストークン** ](/docs/ja-jp/secure/tokens/access-tokens)を受け入れます。

    別のフロントエンドアプリケーションは通常、これらのタイプのバックエンドと対話するために構築されます。これには、[シングルページアプリケーション](/docs/ja-jp/quickstart/spa)や[ネイティブまたはモバイルアプリ](/docs/ja-jp/quickstart/native)（Auth0はこれらすべてに対しSDKも提供）などさまざまな可能性があります。

    ユーザーがバックエンドアプリケーションと対話する必要がある場合、まず、フロントエンドアプリケーションを使ってAuth0と認証を行います。フロントエンドアプリケーションはAuth0からアクセストークンを取得し、これを使ってユーザーに代わって、バックエンドアプリケーションに要求することができます。

    名前が示唆するように、[アクセストークン](/docs/ja-jp/secure/tokens/access-tokens)はアクセス制御（認可）の問題に対処するように設計されており、ユーザーに関する情報は含まれていません。**バックエンドアプリケーションは、アクセストークンとのみ動作します。** [Management API](https://auth0.com/docs/api/management/v2)を使ってトークンを作成したユーザーに関する情報を取得することができます。これについては後で説明します。

      <Section id={sections[0].id} title={sections[0].title} stepNumber="1">
      **Laravelアプリケーションをまだセットアップしていない場合** には、シェルを開いて、新規プロジェクトに適切なディレクトリに移動し、次のコマンドを実行します：

      ```
      composer create-project --prefer-dist laravel/laravel auth0-laravel-api ^9.0
      ```

      このガイドにあるすべてのコマンドは、Laravelプロジェクトディレクトリのルートから実行されていることを前提としています。必ず新規プロジェクトのディレクトリに移動（`cd`）してください：

      ```
      cd auth0-laravel-api
      ```
      </Section>

      <Section id={sections[1].id} title={sections[1].title} stepNumber="2">
      プロジェクトディレクトリで次のコマンドを実行して、[Auth0 Laravel SDK](https://github.com/auth0/laravel-auth0)をインストールします：

      ```
      composer require auth0/login:^7.8 --update-with-all-dependencies
      ```

      そして、アプリケーションにSDK構成ファイルを生成します：

      ```
      php artisan vendor:publish --tag auth0
      ```
      </Section>

      <Section id={sections[2].id} title={sections[2].title} stepNumber="3">
      プロジェクトディレクトリから次のコマンドを実行して、[Auth0 CLI](https://github.com/auth0/auth0-cli)をダウンロードします：

      ```
      curl -sSfL https://raw.githubusercontent.com/auth0/auth0-cli/main/install.sh | sh -s -- -b .
      ```

      そして、Auth0アカウントを使ってCLIを認証し、プロンプトでユーザーとしてログインすることを選択します：

      ```
      ./auth0 login
      ```

      次に、Auth0で新しいアプリケーションを作成します：

      ```
      ./auth0 apps create \
      --name "My Laravel Backend" \
      --type "regular" \
      --auth-method "post" \
      --callbacks "http://localhost:8000/callback" \
      --logout-urls "http://localhost:8000" \
      --reveal-secrets \
      --no-input \
      --json > .auth0.app.json
      ```

      また、新しいAPIも作成します：

      ```
      ./auth0 apis create \
      --name "My Laravel Backend API" \
      --identifier "https://github.com/auth0/laravel-auth0" \
      --offline-access \
      --no-input \
      --json > .auth0.api.json
      ```

      これで、SDKを構成するプロジェクトディレクトリ内に2つのファイルが作成されます。

      これらのファイルには資格情報が保管されているため、機密として扱うことが重要です。必ず、バージョン管理では、これらのファイルをコミットしないようにしてください。Gitを使用している場合は、必ず`.gitignore`ファイルに追加します：

      ```
      echo ".auth0.*.json" >> .gitignore
      ```
      </Section>

      <Section id={sections[3].id} title={sections[3].title} stepNumber="4">
      SDKは、`api`ミドルウェアと併用するLaravelアプリケーションで認可ガードを自動的に登録します。Laravelはデフォルトで、アプリケーションの`routes/api.php`ファイルのすべてのルートに適用します。

      <Warning>
      構成を追加せずにSDKが期待通りに動作するには、**`routes/api.php`** **ファイルでルートを定義する必要があります。**
      </Warning>

      アプリケーションの経路へのアクセスを制約するには、Auth0 SDKの認可ガードを使用することができます。

      `Authorization`ヘッダーで有効なアクセストークンを含まない要求を拒否するには、Laravelの`auth`ミドルウェアを使用することができます。

      ```
      Route::get('/private', function () {
      return response()->json([
      'message' => 'Your token is valid; you are authorized.',
      ]);
      })->middleware('auth');
      ```

      また、これをLaravelの`can`ミドルウェアと組み合わせると、提供されたトークンに特定の[権限](/docs/ja-jp/manage-users/access-control/rbac)を要求することができます。

      ```
      Route::get('/scope', function () {
      return response()->json([
      'message' => 'Your token is valid and has the read:messages permission; you are authorized.',
      ]);
      })->middleware('auth')->can('read:messages');
      ```
      </Section>

      <Section id={sections[4].id} title={sections[4].title} stepNumber="5">
      提供されたアクセストークンについての情報は、Laravelの`Auth`ファサードまたは`auth()`ヘルパー関数を介して利用できます。

      以下は、ユーザーの識別子とメールアドレスを取得する例です。

      ```
      Route::get('/', function () {
      if (! auth()->check()) {
      return response()->json([
      'message' => 'You did not provide a valid token.',
      ]);
      }
      return response()->json([
      'message' => 'Your token is valid; you are authorized.',
      'id' => auth()->id(),
      'token' => auth()?->user()?->getAttributes(),
      ]);
      });
      ```
      </Section>

      <Section id={sections[5].id} title={sections[5].title} stepNumber="6">
      [Auth0 Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md)を使って、Auth0からアクセストークンを作成したユーザーについての情報を取得することができます。SDKにはこのAPIに便利なラッパーが備わっており、SDKの`management()`メソッドからアクセス可能です。

      **Management APIを呼び出す前に、アプリケーションがManagement APIと通信できるようにしなければなりません。** これを実行するには、[Auth0 DashboardのAPIページ](https://manage.auth0.com/#/apis/)で`［Auth0 Management API］`を選択してから［Machine to Machine Applications（M2Mアプリケーション）］タブを選択します。Laravelアプリケーションを認可してから、下矢印をクリックして、付与したいスコープを選択します。

      以下の例では、`read:users`スコープを付与する必要があります。APIエンドポイントのリストと必要なスコープについては、[Management APIのドキュメント](https://auth0.com/docs/api/management/v2)を参照してください。

      ```
      use Auth0\Laravel\Facade\Auth0;
      Route::get('/me', function () {
      $user = auth()->id();
      $profile = cache()->get($user);
      if (null === $profile) {
      $endpoint = Auth0::management()->users();
      $profile = $endpoint->get($user);
      $profile = Auth0::json($profile);
      cache()->put($user, $profile, 120);
      }
      $name = $profile['name'] ?? 'Unknown';
      $email = $profile['email'] ?? 'Unknown';
      return response()->json([
      'name' => $name,
      'email' => $email,
      ]);
      })->middleware('auth');
      ```

      <Info>
      **アプリケーションでユーザー情報を短期間キャッシュする必要があります。** これによって、アプリケーションがAuth0に対して行う要求数を減らし、パフォーマンスが向上します。ユーザー情報をアプリケーションに長期間保存するとデータが古くなる可能性があるため避けてください。ユーザーの識別子以外のユーザー情報を持続的データベースに保存することも避けてください。
      </Info>
      </Section>

      <Section id={sections[6].id} title={sections[6].title} stepNumber="7">
      Laravelアプリケーションを起動する準備が整いました。要求を受け付けることができます：

      ```
      php artisan serve
      ```
      </Section>

      <Section id={sections[7].id} title={sections[7].title} stepNumber="8">
      [アクセストークンの取得については、こちらに](/docs/ja-jp/secure/tokens/access-tokens/get-access-tokens)詳しく記載されています。ただし、このクイックスタートでは、[API設定の［test（テスト）］ビュー](https://manage.auth0.com/#/apis)からアクセストークンを簡単に使用することができます。

      <Info>
      上で作成した`/me`ルートには関連付けられた実際のユーザーが存在しないため、テストトークンで動作しません。
      </Info>

      <Note>
      ##### チェックポイント
      シェルを開き、アプリケーションに要求を発行するようにします。
      まず、パブリックルートを要求します。
      curl --request GET \ --url http://localhost:8000/api \ --header 'Accept: application/json'
      次に、Authorizationヘッダーでアクセストークンを使用して、保護されたルートを要求します。
      curl --request GET \ --url http://localhost:8000/api/private \ --header 'Accept: application/json' \ --header 'Authorization: Bearer YOUR\_ACCESS\_TOKEN'
      最後に、スコープで保護されたルートを要求するようにします。この要求は、アクセストークンにread:messagesスコープが付与されている場合にのみ成功します。
      curl --request GET \ --url http://localhost:8000/api/scope \ --header 'Accept: application/json' \ --header 'Authorization: Bearer YOUR\_ACCESS\_TOKEN'
      </Note>

      ### その他の情報

      - [ユーザーリポジトリとモデル](https://github.com/auth0/laravel-auth0/blob/main/docs/Users.md)はAuth0 Laravel SDKを拡張して、カスタムのユーザーモデルを使用し、データベースでユーザーの保管や取得を行う方法を指定することができます。
      - [イベントフック](https://github.com/auth0/laravel-auth0/blob/main/docs/Events.md)はAuth0 Laravel SDKで発生したイベントをリッスンする方法を処理して、統合の動作を完全にカスタマイズすることができます。
      - [Management API](https://github.com/auth0/laravel-auth0/blob/main/docs/Management.md)対応はAuth0 Laravel SDKに組み込まれているため、LaravelアプリケーションからManagement APIと対話することができます。
      </Section>

    ## 次のステップ

    成功です！ここまで来れば、アプリケーションにログイン、ログアウト、ユーザープロファイル情報が備わっているはずです。

    これでクイックスタートチュートリアルは終了ですが、機能はまだまだたくさんあります。Auth0でできることについて詳しくは、以下をご覧ください。

    *   [Auth0 Dashboard](https://manage.auth0.com/#) - Auth0のテナントやアプリケーションを構成して管理する方法について説明します
    *   [laravel-auth0 SDK](https://github.com/auth0/laravel-auth0) - このチュートリアルで使用されているSDKをより詳しく説明します
    *   [Auth0 Marketplace](https://marketplace.auth0.com/) - Auth0の機能性を拡張できる各種の統合を見つけられます
  </Content>

  <SideMenu sections={sections}>
      <SideMenuSectionItem id={sections[0].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[1].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[2].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[3].id}>
        <Api />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[4].id}>
        <Api2 />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[5].id}>
        <Api3 />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[6].id}>
        <SignUpForm />
      </SideMenuSectionItem>

      <SideMenuSectionItem id={sections[7].id}>
        <SignUpForm />
      </SideMenuSectionItem>

    </SideMenu>
</Recipe>
